- name: Add Nginx config
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: 0644
  become: true
  notify: reload nginx

- name: Add Nginx site
  template:
    src: nginx-catalogage.conf.j2
    dest: /etc/nginx/sites-available/catalogage.conf
    owner: root
    group: root
    mode: 0644
  become: true
  notify: reload nginx

- name: Ensure Nginx site is default
  file:
    src: /etc/nginx/sites-available/catalogage.conf
    dest: /etc/nginx/sites-enabled/default
    state: link
  become: true
  notify: reload nginx

- name: Create and install certificates
  shell: certbot run -n --nginx --agree-tos --redirect --staple-ocsp --must-staple -d "{{ domain_name }}" --email "{{ letsencrypt_email }}"
  args:
    creates: "/etc/letsencrypt/live/{{ domain_name }}"
  become: true
  when: tls_enabled
  notify: reload nginx
